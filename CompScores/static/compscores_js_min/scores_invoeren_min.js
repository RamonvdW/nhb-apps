/*!
 * Copyright (c) 2020-2025 Ramon van der Winkel.
 * All rights reserved.
 * Licensed under BSD-3-Clause-Clear. See LICENSE file for details.
 */
const dataset=document.getElementById("js_data").dataset;const wedstrijdMaxScore=parseInt(dataset.wedstrijdMaxScore);const toonTeamNaam=dataset.toonTeamNaam==="true";const teamPk2Naam=JSON.parse(document.getElementById('team_pk2naam').textContent);function opzoeken_hide_status(){const el=document.getElementById("id_zoekstatus");el.classList.add("hide");}function opzoeken_toon_status(dataset2,tekst,color){const el=document.getElementById("id_zoekstatus");el.classList.remove("hide");el.innerHTML=tekst;el.style.color=color;}function opzoeken_klaar(xhr,btn){let is_fail=true;if(xhr.readyState===XMLHttpRequest.DONE&&xhr.status===200){if(xhr.responseText!==""){const rsp=JSON.parse(xhr.responseText);const el=document.getElementById('id_zoekresultaat');el.value=rsp;if(rsp['fail']===undefined){is_fail=false;for(let d in btn.dataset){if(d!=='xhr'&& d!=='opzoeken'){let antwoord=rsp[d];if(antwoord!==undefined){let el=document.getElementById(btn.dataset[d]);el.innerHTML=antwoord;el.style.color="";}}}}}}const el1=document.getElementById("id_btn_toevoegen");const el2=document.getElementById("id_zoekresultaten");if(is_fail){opzoeken_toon_status(btn.dataset,"niet gevonden","red");el1.disabled=true;el2.classList.add("hide");}else{opzoeken_hide_status();el1.disabled=false;el2.classList.remove("hide");}}function opzoeken_timeout(xhr){xhr.abort();}function opzoeken(btn){if(btn.dataset['xhr']===undefined){opzoeken_toon_status(btn.dataset,"bezig..","gray");const xhr=new XMLHttpRequest();let obj={wedstrijd_pk:dataset.wedstrijdPk};for(let d in btn.dataset){if(d==='opzoeken'){let el=document.getElementById(btn.dataset[d]);let lid_nr=el.value.slice(0,6);if(lid_nr===''){return;}obj['lid_nr']=lid_nr;}}document.getElementById('id_btn_toevoegen').disabled=true;btn.dataset.xhr=xhr;const data=JSON.stringify(obj);xhr.open("POST",dataset.urlCheckBondsnummer,true);xhr.timeout=3000;xhr.onloadend=function(){opzoeken_klaar(xhr,btn);delete btn.dataset.xhr;};xhr.ontimeout=function(){opzoeken_timeout(xhr)};xhr.setRequestHeader("X-CSRFToken",dataset.csrfToken);xhr.send(data);}}function toevoegen(){const el_rsp=document.getElementById('id_zoekresultaat');const rsp=el_rsp.value;el_rsp.value="";const el_gevonden=document.getElementById('id_zoekresultaten');el_gevonden.classList.add("hide");const lid_nr=rsp['lid_nr'];const table=document.getElementById('table1');const body=table.tBodies[0];let row_smaller=0;for(let i=0;i<body.rows.length;i++){const row=body.rows[i];const filter_cmd=row.dataset["tablefilter"];if(filter_cmd==="stop"){break;}const row_lid_nr=row.cells[0].innerText;if(row_lid_nr<lid_nr){row_smaller=i;}}const el_filter=document.getElementById(dataset.tableFilterInputId);el_filter.value="";myTableFilter(el_filter,'table1');const base_row=body.rows[0];let insert_after_row=body.rows[row_smaller];let focus_row=null;let added_new=false;rsp['deelnemers'].forEach(deelnemer =>{let peek_row=body.rows[row_smaller+1];let peek_pk=peek_row.cells[0].dataset.pk;if(peek_pk===deelnemer['pk']){row_smaller=row_smaller+1;insert_after_row=peek_row;if(!focus_row){focus_row=peek_row;}}else{const new_row=base_row.cloneNode(true);new_row.cells[0].removeAttribute("data-clean_text");new_row.cells[1].removeAttribute("data-clean_text");new_row.cells[2].removeAttribute("data-clean_text");insert_after_row.parentNode.insertBefore(new_row,insert_after_row.nextSibling);new_row.cells[0].dataset.pk=deelnemer['pk'];new_row.cells[0].innerHTML=lid_nr;new_row.cells[1].innerHTML=rsp['naam'];let span=new_row.cells[2].firstChild;span.innerHTML="["+rsp['ver_nr']+"]";span.nextSibling.innerHTML=" "+rsp['ver_naam'];new_row.cells[3].innerHTML=deelnemer['boog'];let team_gem=deelnemer['team_gem'];if(team_gem!==''){new_row.cells[3].innerHTML+=' ('+team_gem+')';}if(toonTeamNaam){let team_pk=deelnemer['team_pk'];new_row.cells[5].innerHTML=teamPk2Naam[team_pk];}new_row.classList.remove('hide');if(!added_new){added_new=true;focus_row=new_row;}row_smaller=row_smaller+1;insert_after_row=new_row;}});if(focus_row){focus_row.cells[4].firstChild.focus();}document.getElementById('id_lid_nr').value="";const el_naam=document.getElementById('id_naam');el_naam.innerHTML="Naam van de sporter";el_naam.style.color="grey";const el_ver=document.getElementById('id_ver');el_ver.innerHTML="Naam van de vereniging";el_ver.style.color="grey";document.getElementById('id_regio_').innerHTML="";document.getElementById('id_btn_toevoegen').disabled=true;}function opslaan_klaar(xhr){if(xhr.readyState===XMLHttpRequest.DONE){if(xhr.status===200){M.toast({html:'De scores zijn opgeslagen'});}else{M.toast({html:'Opslaan is NIET gelukt'});}}}function opslaan(btn){const table=document.getElementById('table1');const body=table.tBodies[0];let obj={wedstrijd_pk:dataset.wedstrijdPk};for(let i=1;i<body.rows.length;i++){let row=body.rows[i];const filter_cmd=row.dataset["tablefilter"];if(filter_cmd==="stop"){break;}const pk=row.cells[0].dataset.pk;const score=row.cells[4].firstChild.value;obj[pk]=score;}const data=JSON.stringify(obj);btn.disabled=true;const xhr=new XMLHttpRequest();xhr.open("POST",dataset.urlOpslaan,true);xhr.timeout=3000;xhr.onloadend=function(){btn.disabled=false;opslaan_klaar(xhr);};xhr.ontimeout=function(){btn.disabled=false;M.toast({html:'Opslaan is NIET gelukt'});};xhr.setRequestHeader("X-CSRFToken",dataset.csrfToken);xhr.send(data);}function deelnemers_ophalen_toevoegen(rsp){const table=document.getElementById('table1');const body=table.tBodies[0];const base_row=body.rows[0];base_row.cells[0].removeAttribute("data-clean_text");base_row.cells[1].removeAttribute("data-clean_text");base_row.cells[2].removeAttribute("data-clean_text");const el_filter=document.getElementById("table1_zoeken_input");el_filter.value="";myTableFilter(el_filter,'table1');let deelnemers=rsp['deelnemers'];deelnemers.sort(function(a,b){if(a.lid_nr!==b.lid_nr){return a.lid_nr-b.lid_nr}else{return a.pk-b.pk}});let first_added_row;let row_nr=0;deelnemers.forEach(deelnemer =>{const pk=deelnemer['pk'];const lid_nr=deelnemer['lid_nr'];let skip=false;while(row_nr<=body.rows.length){const row=body.rows[row_nr];const filter_cmd=row.dataset["tablefilter"];if(filter_cmd==="stop"){row_nr-=1;break;}const row_pk=row.cells[0].dataset.pk;const row_lid_nr=row.cells[0].innerText;if(pk==row_pk){skip=true;break;}else if(lid_nr<row_lid_nr||(lid_nr==row_lid_nr&&pk<row_pk)){row_nr-=1;break;}else{row_nr+=1;}}if(!skip){const row=body.rows[row_nr];const new_row=base_row.cloneNode(true);new_row.cells[0].innerHTML=lid_nr;new_row.cells[0].dataset.pk=deelnemer['pk'];new_row.cells[1].innerHTML=deelnemer['naam'];const span=new_row.cells[2].firstChild;span.innerHTML="["+deelnemer['ver_nr']+"]";span.nextSibling.innerHTML=" "+deelnemer['ver_naam'];new_row.cells[3].innerHTML=deelnemer['boog'];const team_gem=deelnemer['team_gem'];if(team_gem!==''){new_row.cells[3].innerHTML+=' ('+team_gem+')';}if(toonTeamNaam){const team_pk=deelnemer['team_pk'];new_row.cells[5].innerHTML=teamPk2Naam[team_pk];}row.parentNode.insertBefore(new_row,row.nextSibling);row_nr+=1;if(first_added_row===undefined){first_added_row=row_nr;}}});if(first_added_row!==undefined){for(let i=1;i<body.rows.length;i++){let row=body.rows[i];const filter_cmd=row.dataset["tablefilter"];if(filter_cmd==="stop"){break;}row.classList.remove('hide');if(i===first_added_row){row.cells[4].firstChild.focus();}}}}function deelnemers_ophalen_klaar(xhr,btn){if(xhr.readyState===XMLHttpRequest.DONE){if(xhr.status===200){if(xhr.responseText!==""){const rsp=JSON.parse(xhr.responseText);deelnemers_ophalen_toevoegen(rsp);const el=document.getElementById("table1_zoeken_input");el.focus();}}else{btn.disabled=false;}}}function deelnemers_ophalen(btn){btn.disabled=true;const obj={deelcomp_pk:dataset.deelcompPk,wedstrijd_pk:dataset.wedstrijdPk};const data=JSON.stringify(obj);const xhr=new XMLHttpRequest();xhr.open("POST",dataset.urlDeelnemersOphalen,true);xhr.timeout=5000;xhr.onloadend=function(){deelnemers_ophalen_klaar(xhr,btn);};xhr.ontimeout=function(){btn.disabled=false;};xhr.setRequestHeader("X-CSRFToken",dataset.csrfToken);xhr.send(data);}function controleer_score(el){let color="";const value=el.value;if(/\D/.test(value)||value<0||value>wedstrijdMaxScore){color="red";}el.style.color=color;}